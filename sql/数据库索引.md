## 数据库索引

本文主要参考：[一文搞定数据库索引](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651962936&idx=1&sn=2f4a97187134ed584273550104672694&chksm=bd2d0be48a5a82f2e5703e55272f6e3ee60954efd8d08b46232c3e24ec5632691ccc66973553&token=331401046&lang=zh_CN&scene=25#wechat_redirect)

### 准备

- 索引的数据结构（索引的类型，为什么快）
- 聚集索引与非聚集索引
- 创建索引的规则
- 不能命中索引的情况
- 联合索引



### 什么是索引：

优化查询，查询更快...

#### 索引的目的：

为了提高数据查询的效率，就像书的目录一样，一本 500 页的书，如果你想快速找到其中的某一个知识点，在不借助目录的情况下，那我估计你可得找一会儿。同样，对于数据库的表而言，索引其实就是它的“目录”。

#### 如何建立目录：

如何存储这个目录，然后能实现快速查找和插入的需求，数组？哈希表？搜索树？索引实际是一种能提高读写效率的数据结构，一般都采用B+树（多路平衡搜索树）这种数据结构，这个B+树会存储你索引字段的所有数据。当你查找某条记录的时候，之前先查找这个B+树的数据，然后再去查找数据库整行的数据，那又是怎么通过索引字段找到数据库表整行数据的？

#### 为什么是树，为什么是B+树：

- 哈希表?

做区间查询时速度很慢，只适用于等值查询的场景,分组：group by？排序：order by？

- 数组？

数组修改的时候效率很低，只适用于数据不会修改的情形

- 树？ 

  - 区间查询？
  - 高效的读，写？
  - 二叉树->B-树->B+树  

   [数据库索引，到底是什么做的？](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961486&idx=1&sn=b319a87f87797d5d662ab4715666657f&chksm=bd2d0d528a5a84446fb88da7590e6d4e5ad06cfebb5cb57a83cf75056007ba29515c85b9a24c&scene=21#wechat_redirect)

  二叉树

  ![二叉树](.\pic\二叉树.png)

cpu>内存>磁盘

B树是一种多路平衡查询树，它的每个节点最多包含m个孩子,m被称为B树的阶，一个m阶的B树具有如下几个特征：

- 根结点至少有两个子女
- 每个中间节点都包含k-1个元素和k个孩子，其中 m/2 <= k <= m
- 每一个叶子节点都包含k-1个元素，其中 m/2 <= k <= m
- 所有的叶子结点都位于同一层
- 每个节点中的元素从小到大排列，节点当中k-1个元素正好是k个孩子包含的元素的值域分划

![B树](.\pic\B树.png)

**一个m阶的B+树具有如下几个特征**：

- 有k个子树的中间节点包含有k个元素（B树中是k-1个元素），每个元素不保存数据，只用来索引，所有数据都保存在叶子节点
- 所有的叶子结点中包含了全部元素的信息，及指向含这些元素记录的指针，且叶子结点本身依关键字的大小自小而大顺序链接
- 所有的中间节点元素都同时存在于子节点，在子节点元素中是最大（或最小）元素。

![B+树](.\pic\B+.png)

在数据库的聚集索引（Clustered Index）中，叶子节点直接包含卫星数据。在非聚集索引（NonClustered Index）中，叶子节点带有指向卫星数据的指针。

B树与B+树的区别：[什么是B+树](https://mp.weixin.qq.com/s/jRZMMONW3QP43dsDKIV9VQ)

- B树中无论是中间节点还是叶子节点都包含卫星数据；而B+树种只有叶子节点包含卫星数据
- 单一节点存储更多的元素，B+树比B树更加“矮胖”，IO次数更少
- 所有查询都要查找到叶子节点，B+树比B树查找更加稳定
- 所有叶子节点形成有序链表，B+树便于范围查询

小测试：

#### MyISAM和InnoDB的索引实现差异：

##### MyISAM索引：

MyISAM的索引与行记录是分开存储的，叫做**非聚集索引**（UnClustered Index）

其主键索引与普通索引没有本质差异：

- 有连续聚集的区域单独存储行记录
- 主键索引的叶子节点，存储主键，与对应行记录的指针
- 普通索引的叶子结点，存储索引列，与对应行记录的指针
- *MyISAM的表可以没有主键*
- 主键索引与普通索引是两棵独立的索引B+树，通过索引列查找时，先定位到B+树的叶子节点，再通过指针定位到行记录。

![非聚集索引](.\pic\非聚集索引.png)

##### InnoDB索引：

InnoDB的**主键索引与**行记录是存储在一起的，故叫做**聚集索引**（Clustered Index）：

- 没有单独区域去存储行记录
- 主键索引的叶子节点，存储主键，与对应行记录（而不是指针）
- 普通索引的叶子节点，存储主键（也不是指针）
- InnoDB的表必须要有聚集索引,也只能够有一个，因为数据行在物理磁盘上只能有一份聚集存储

![聚集索引](.\pic\聚集索引.png)

对于InnoDB表，这里的启示是：

- 不建议使用较长的列做主键，例如char(64)，因为所有的普通索引都会存储主键，会导致普通索引过于庞大；

- 建议使用趋势递增的key做主键，由于数据行与索引一体，这样不至于插入记录时，有大量索引分裂，行记录移动；

### 创建索引的规则

- 三星索引
- 字段大小
- 